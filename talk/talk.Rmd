```{r setup, include=FALSE}
opts_chunk$set(tidy = FALSE) # preserve wrapped code
opts_chunk$set(dev = 'pdf') # size plots better
opts_chunk$set(fig.cap = "")
require(plyr)
require(reshape2) # for 'tips' dataset
require(ggplot2)
require(grid) # for "unit" function for ggplot legend size
require(rdatamarket)
require(forecast)
require(XML)
require(xtable)
require(maps)
require(stinepack) # for ggplot equivalent of decompose
```

# Introduction

### Tail Wags Dog

### Scale of Problem
* Formal Documents
    * papers
    * reports
    * OIAs
* Informal documents
    * information requests
    * preliminary analyses
* Online Content
    * web/intranet
    * Stats NZ
* User Interaction
    * interactive charts
    * online forms

### Put It in an Email
* Text
* Workflow
* Toolchain

# Text

## Human-Readable
### Human-Readable

### Database
    CustomerID varchar(5) NOT NULL,  
    CompanyName varchar(40) NOT NULL,  
    ContactName varchar(30),  
    ContactTitle varchar(30),  
    Address varchar(60)  
    City varchar(15),  
    Region varchar(15),  
    PostalCode varchar(10),  

### Data Transfer (email)
\scriptsize{MIME-Version: 1.0\\
Received: by 10.141.132.10 with HTTP; Fri, 27 Feb 2013 22:18:46 -0800 (PST)\\
Date: Sat, 28 Feb 2009 19:18:46 +1300\\
Delivered-To: nacnudus@gmail.com\\
Message-ID: <646bfbfc0902272218k33f818a0n257983794298ae74@mail.gmail.com>\\
Subject: A good joke\\
From: Duncan Garmonsway <obfuscated1@gmail.com>\\
To: Harold Garmonsway <obfuscated2@gmail.com>\\
Content-Type: multipart/alternative; boundary=000e0cd29660dd3ae20463f48edd\\
--000e0cd29660dd3ae20463f48edd\\
Content-Type: text/plain; charset=ISO-8859-1\\
Content-Transfer-Encoding: 7bit\\
\vspace*{2\baselineskip}}
\small{Shakespeare on Excel:
=OR(B2,NOT(B2))}

### Data Transfer (application)
    <META HTTP-EQUIV="Content-Type"
        CONTENT="text/html; charset=iso-8859-1">
    <META NAME="Generator" 
        CONTENT="MS Exchange Server 
        version 08.02.0254.000">
    <TITLE>Weekly Report</TITLE>

### Data Transfer (web)


### Integrity

## Version Control

### Diff
\includegraphics[width=4in]{figures/diff.png}

### Folder Structure
### Diff Tree


# Workflow

## LCFD

### LCFD

## Load

### Local File
### Database
### Web

## Clean

### Pivot
### Impossible Pivot
### Re-Coding

## Functions

### Pivot (again)
### Plot

## Do

### Facet
```{r bayOfPlenty, echo = FALSE, fig.width = 4, fig.height = 3}
x <- read.csv("BoP.csv", header = TRUE)
colnames(x) <- c("count", "hour", "weekend", "fatal", "alcohol", "urban")
x$count <- as.numeric(x$count)
x$hour <- as.numeric(x$hour)
# abbreviate alcohol column for graph labels
alc <- factor(c("alc/drug", "clean"))
x$alcohol <- alc[x$alcohol]
y <- dcast(x, hour + weekend + fatal + alcohol + urban ~ ., fun.aggregate = sum, value.var = "count")
colnames(y)[6] <- "count"
y <- y[rep(row.names(y), y$count), 1:5]
ggplot(y, aes(hour, group = weekend, fill = weekend)) + 
  geom_density(alpha = 0.2) + 
  facet_grid(alcohol ~ urban, margins = TRUE) +
  theme(legend.position="bottom", legend.title=element_blank()) +
  theme(legend.key.size = unit("0.2", "cm")) +
  theme(axis.text.y = element_blank(), axis.ticks.y = element_blank())
```

### Map
```{r map, fig.width = 4, fig.height = 2.8}
map("nz", mar = c(0,0,0,0))
```

### Forecast
```{r gas, echo = FALSE, fig.width = 4, fig.height = 3.5, cache = TRUE}
plot(forecast(gas), main = "Australian monthly gas production")
```

### Decompose
```{r gasDecompose, echo = FALSE, fig.width = 4, fig.height = 3, cache = TRUE}
# function for ggplot equivalent of decompose on a timeseries
decomp <- function(series,frequency){ 
    x <- na.stinterp(series)  #this is for interpolation 
    x1 <- ts(x,start=01,freq=frequency) #converting into a ts object
    x2 <- stl(x1,s.window="periodic") #performing stl on the ts object
    x3 <- data.frame(x,x2$time.series) #creating a data.frame
    x3$index <- index(x3) #create an id 
    colnames(x3)[1] <- "time-series"  
    x4 <- melt(x3,id.vars="index")   #melt the dataframe into long format  
    ggplot(x4,aes(index,value,group=variable)) + geom_line(alpha=0.7) + facet_grid(variable ~., scales="free")  + xlab("Timesteps") + ylab("values") + theme(axis.text = element_blank(), axis.ticks = element_blank())
}
decomp(as.numeric(gas), 12)
```

### Forecast (harder)
```{r setupBeer, echo = FALSE}
# beer production
dminit("4b3320aa36214e35a7d0c6c175a1ff98") # rdatamarket api key
beer <- dmlist("22ry") # download
beer$Year <- as.numeric(substr(as.character(beer$Quarter), 1, 4)) # extract year from quarter
annual <- ddply(beer[1:152, ], .(Year), summarize, Production = sum(Value)) # summarize by year
# forecast with forecast package
goodForecast <- forecast(as.ts(annual[1:34, "Production"]), h = 4)
goodConfidence <- data.frame(goodForecast$upper, goodForecast$lower)
goodForecast <- data.frame(Year = seq(1990, 1993), Production = goodForecast$mean) # df for ggplot
# forecast with simple regression
production <- annual[1:34, "Production"]
year <- annual[1:34, "Year"]
poorForecast <- lm(production ~ year) 
pred <- predict(poorForecast, data.frame(year = seq(1990, 1993))) # four-year forecast
poorForecast <- data.frame(Year = c(poorForecast$model$year, seq(1990, 1993))
                           , Production <- c(poorForecast$fitted.values, pred))
# preapre plot (plain data to begin with)
p <- ggplot() + xlim(range(annual$Year)) + 
  ylim(range(c(annual$Production, goodForecast$Production, poorForecast$Production, goodConfidence$X2))) + 
  geom_line(data = annual[1:34, ], aes(Year, Production)) + 
  theme(legend.position="none")
```

```{r BeerInvisible, echo = FALSE, fig.width = 4, fig.height = 3}
p
```

### Forecast (harder)
```{r BeerVisible, echo = FALSE, fig.width = 4, fig.height = 3}
p <- p + labs(title="Australian Annual Beer Production")
p
```

### Forecast (harder)
```{r BeerForecast1, echo = FALSE, fig.width = 4, fig.height = 3}
p <- p + geom_line(aes(Year, Production),  poorForecast, colour = "red")
p
```

### Forecast (harder)
```{r BeerForecast2, echo = FALSE, fig.width = 4, fig.height = 3}
p <- p + geom_line(aes(Year, Production), goodForecast, colour = "blue") +
  geom_ribbon(data=goodConfidence,aes(x = seq(1990, 1993), ymax = X1, ymin=X1.1), alpha=0.2)
p
```

### Forecast (harder)
```{r BeerForecast3, echo = FALSE, fig.width = 4, fig.height = 3}
p <- p + geom_line(aes(Year, Production), annual[34:38, ], colour = "darkgreen")
p
```

### Cluster

# Toolchain

## Database

### Scale
### Workspace

## Programming Language

### Languages
* R
* SAS
* SPSS
* S Plus

`cell_value = SUM(1, 2, 3)`
  
`variable <- sum(1, 2, 3)`

### Extensibility

## Presentation

### Paper
### Shiny
### Slidify

## Open Source

### Documentation

### Collaboration (support)
"The third problem in your code is, you are print()ing plots from R base graphics. Sigh. Printing base graphics does not make any sense."

### Pace of Development
```{r packages, echo = FALSE, fig.width = 4, fig.height = 3, cache = TRUE}
# adapted from http://blog.revolutionanalytics.com/2013/05/how-r-grows.html for packages and maintainers
url <- "http://cran.r-project.org/web/packages/available_packages_by_date.html"
page <- readHTMLTable(url, stringsAsFactors = FALSE)[[1]]
names(page) <- c("Date","Package","Title")
page$Year <- as.factor(substr(page$Date,1,4))
# plot
cbbPalette <- c(rep("#E69F00",3), "#56B4E9", "#009E73", "#F0E442", "#0072B2", "#D55E00", "#CC79A7")
barP <- ggplot(page, aes(factor(Year)))
barP + geom_bar(fill=cbbPalette) +
  labs(title = "Available Packages") +
  ylab("Number") +
  xlab("Year of Last Update")
```

### Developers
```{r echo = FALSE, results='asis'}
x <- read.csv("maintainersShort.txt", header = FALSE)
colnames(x) <- c("Maintainer", "Position", "University")
print(xtable(x), size = "\\tiny", comment = FALSE)
```

### Thank You
\begin{center}
\LARGE{Questions?}
\end{center}
